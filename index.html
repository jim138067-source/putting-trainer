<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stroke Trainer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      min-height: 100vh; 
      background: linear-gradient(145deg, #0a0a0a 0%, #1a1a1a 50%, #0d1f0d 100%); 
      color: #fff; 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      overflow-x: hidden;
    }
    .container { padding: 16px; max-width: 500px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 24px; padding-top: 16px; }
    .title { 
      font-size: 28px; font-weight: 700; letter-spacing: 3px; margin: 0 0 4px 0;
      background: linear-gradient(90deg, #ff6b35, #f7c59f); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .title-small { font-size: 20px; color: #fff; font-weight: 600; letter-spacing: 2px; margin: 0; }
    .setup-card { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 24px; margin-bottom: 24px; }
    .control-group { margin-bottom: 24px; }
    .control-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .control-label { font-size: 12px; color: rgba(255,255,255,0.5); letter-spacing: 1px; }
    .control-value { font-size: 32px; font-weight: 700; color: #ff6b35; }
    input[type="range"] { 
      width: 100%; height: 8px; border-radius: 4px; appearance: none; cursor: pointer; margin-bottom: 8px;
      background: rgba(255,255,255,0.2);
    }
    input[type="range"]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #fff; cursor: pointer; }
    .slider-labels { display: flex; justify-content: space-between; font-size: 11px; color: rgba(255,255,255,0.4); }
    .fine-tune-row { display: flex; justify-content: center; gap: 12px; margin-top: 12px; }
    .fine-tune-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px 24px; color: #fff; font-size: 16px; cursor: pointer; }
    .arc-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .arc-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px 14px; color: #fff; font-size: 14px; cursor: pointer; min-width: 48px; }
    .arc-btn.active { background: linear-gradient(135deg, #ff6b35, #e55a2b); border: none; font-weight: 600; }
    .primary-btn { width: 100%; background: linear-gradient(135deg, #ff6b35, #e55a2b); border: none; border-radius: 12px; padding: 16px; color: #fff; font-size: 16px; font-weight: 600; letter-spacing: 1px; cursor: pointer; margin-bottom: 16px; }
    .secondary-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 14px 24px; color: #fff; font-size: 14px; cursor: pointer; }
    .info-box { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; border-left: 3px solid rgba(255, 107, 53, 0.5); }
    .info-text { font-size: 13px; color: rgba(255,255,255,0.6); margin: 0; line-height: 1.8; }
    
    .camera-container { position: relative; width: 100%; aspect-ratio: 3/4; background: #000; border-radius: 16px; overflow: hidden; margin-bottom: 16px; }
    .video { width: 100%; height: 100%; object-fit: cover; }
    .overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .camera-placeholder { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); }
    .camera-btn { background: linear-gradient(135deg, #ff6b35, #e55a2b); border: none; border-radius: 50%; width: 72px; height: 72px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .camera-hint { margin-top: 12px; color: rgba(255,255,255,0.5); font-size: 14px; }
    .calibrate-instructions { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin-bottom: 16px; font-size: 14px; color: rgba(255,255,255,0.7); line-height: 1.6; }
    .button-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    
    /* Practice screen - 3 column layout */
    .practice-layout { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; background: #000; }
    
    .metrics-panel { 
      width: 85px; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; 
      padding: 8px 4px; gap: 6px; z-index: 20; overflow-y: auto;
    }
    .metric-box { 
      background: rgba(30,30,30,0.95); border-radius: 8px; padding: 8px 4px; 
      text-align: center; border-left: 3px solid #ff6b35; 
    }
    .metric-box.highlight { border-left-color: #4ade80; background: rgba(74,222,128,0.1); }
    .metric-box-label { font-size: 8px; color: #ff6b35; letter-spacing: 0.5px; margin-bottom: 2px; text-transform: uppercase; }
    .metric-box.highlight .metric-box-label { color: #4ade80; }
    .metric-box-value { font-size: 22px; font-weight: 700; color: #fff; line-height: 1; }
    .metric-box-unit { font-size: 9px; color: rgba(255,255,255,0.5); }
    
    .camera-area { flex: 1; position: relative; overflow: hidden; }
    .camera-area video, .camera-area canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .camera-area video { object-fit: cover; }
    #practice-overlay { z-index: 5; }
    #trace-canvas { z-index: 6; }
    
    .controls-panel { 
      width: 85px; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; 
      padding: 8px 4px; gap: 8px; z-index: 20; align-items: center; 
    }
    .ctrl-btn { 
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); 
      border-radius: 8px; padding: 12px 8px; color: #fff; font-size: 12px; 
      cursor: pointer; width: 72px; text-align: center; font-weight: 600;
    }
    .ctrl-btn.active { background: #4ade80; border-color: #4ade80; color: #000; }
    .ctrl-btn.recording { background: #ff3b30; border-color: #ff3b30; animation: pulse 1s infinite; }
    .ctrl-btn.stop { background: #ff3b30; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    
    .panel-box { 
      background: rgba(30,30,30,0.95); border-radius: 8px; padding: 10px 8px; 
      text-align: center; width: 72px;
    }
    .panel-label { font-size: 9px; color: rgba(255,255,255,0.5); margin-bottom: 4px; }
    .panel-value { font-size: 16px; font-weight: 700; color: #fff; }
    
    .back-btn-float { 
      position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.7); 
      border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 8px 16px; 
      color: #fff; font-size: 14px; cursor: pointer; z-index: 25; 
    }
    
    /* Impact display - shows prominently when stroke detected */
    .impact-display {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85); border-radius: 16px; padding: 20px 32px;
      text-align: center; z-index: 30; display: none;
    }
    .impact-display.show { display: block; animation: fadeInOut 3s forwards; }
    @keyframes fadeInOut { 0% { opacity: 0; } 10% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    .impact-label { font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 8px; }
    .impact-value { font-size: 48px; font-weight: 700; }
    .impact-value.square { color: #4ade80; }
    .impact-value.open { color: #f97316; }
    .impact-value.closed { color: #3b82f6; }
    .impact-hint { font-size: 14px; margin-top: 8px; font-weight: 600; }
    
    /* Review screen */
    .review-container { padding: 16px; max-width: 600px; margin: 0 auto; }
    .review-video-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; background: #000; border-radius: 16px; overflow: hidden; margin-bottom: 16px; }
    .review-video { width: 100%; height: 100%; object-fit: contain; }
    #review-trace-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    
    .review-metrics { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; justify-content: center; }
    .review-metric { 
      background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px 20px; 
      text-align: center; min-width: 100px; flex: 1;
    }
    .review-metric-label { font-size: 10px; color: rgba(255,255,255,0.5); letter-spacing: 1px; margin-bottom: 4px; }
    .review-metric-value { font-size: 28px; font-weight: 700; color: #ff6b35; }
    .review-metric-value.square { color: #4ade80; }
    .review-metric-value.open { color: #f97316; }
    .review-metric-value.closed { color: #3b82f6; }
    .review-metric-hint { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 2px; }
    
    .speed-controls { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 16px; }
    .speed-label { font-size: 12px; color: rgba(255,255,255,0.5); }
    .speed-btn { 
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
      border-radius: 8px; padding: 8px 14px; color: #fff; font-size: 13px; cursor: pointer; 
    }
    .speed-btn.active { background: #ff6b35; border-color: #ff6b35; font-weight: 600; }
    
    .toggle-row { display: flex; gap: 12px; justify-content: center; margin-bottom: 16px; }
    .toggle-btn { 
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
      border-radius: 8px; padding: 10px 16px; color: #fff; font-size: 13px; cursor: pointer; 
    }
    .toggle-btn.active { background: rgba(255,107,53,0.3); border-color: #ff6b35; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Setup Screen -->
  <div id="setup-screen" class="container">
    <div class="header">
      <h1 class="title">STROKE TRAINER</h1>
    </div>
    <div class="setup-card">
      <div class="control-group">
        <div class="control-header">
          <span class="control-label">TEMPO</span>
          <span><span class="control-value" id="bpm-display">76</span> <span class="control-unit">BPM</span></span>
        </div>
        <input type="range" id="bpm-slider" min="60" max="90" value="76">
        <div class="slider-labels"><span>60</span><span>75</span><span>90</span></div>
        <div class="fine-tune-row">
          <button class="fine-tune-btn" id="bpm-minus">‚àí1</button>
          <button class="fine-tune-btn" id="bpm-plus">+1</button>
        </div>
      </div>
      <div class="control-group">
        <div class="control-header">
          <span class="control-label">ARC PATH</span>
          <span class="control-value" id="arc-display">72¬∞</span>
        </div>
        <div class="arc-buttons" id="arc-buttons">
          <button class="arc-btn active" data-arc="72">72¬∞</button>
          <button class="arc-btn" data-arc="74">74¬∞</button>
          <button class="arc-btn" data-arc="76">76¬∞</button>
          <button class="arc-btn" data-arc="78">78¬∞</button>
          <button class="arc-btn" data-arc="80">80¬∞</button>
        </div>
      </div>
    </div>
    <button class="primary-btn" id="start-btn">Start Training</button>
    <div class="info-box">
      <p class="info-text">
        <strong>Setup:</strong><br>
        ‚Ä¢ Mount phone ~30" above putting surface<br>
        ‚Ä¢ Place stickers on putter (blue=heel, pink=toe)<br>
        ‚Ä¢ Position ball at the "Ball Here" marker
      </p>
    </div>
  </div>

  <!-- Calibrate Screen -->
  <div id="calibrate-screen" class="container hidden">
    <div class="header"><h1 class="title-small">CALIBRATION</h1></div>
    <div class="camera-container" id="calibrate-camera-container">
      <video id="calibrate-video" class="video" autoplay playsinline muted></video>
      <canvas id="calibrate-canvas" class="overlay-canvas"></canvas>
      <div class="camera-placeholder" id="calibrate-placeholder">
        <button class="camera-btn" id="calibrate-camera-btn">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="M12 15.2c1.77 0 3.2-1.43 3.2-3.2S13.77 8.8 12 8.8 8.8 10.23 8.8 12s1.43 3.2 3.2 3.2zM9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
        </button>
        <p class="camera-hint">Tap to start camera</p>
        <p id="camera-error" style="color: #ff6b35; font-size: 12px; margin-top: 8px; display: none;"></p>
      </div>
    </div>
    <div class="calibrate-instructions">Position the "Ball Here" circle where you'll place your ball. The arc guide will extend from this point.</div>
    <div class="button-row">
      <button class="secondary-btn" id="calibrate-back-btn">Back</button>
      <button class="primary-btn" id="confirm-calibrate-btn" style="width: auto;">Start Practice</button>
    </div>
  </div>

  <!-- Practice Screen -->
  <div id="practice-screen" class="hidden">
    <div class="practice-layout">
      <!-- Left: Metrics -->
      <div class="metrics-panel">
        <div class="metric-box highlight">
          <div class="metric-box-label">Face Angle</div>
          <div class="metric-box-value" id="live-face">0.0</div>
          <div class="metric-box-unit">degrees</div>
        </div>
        <div class="metric-box">
          <div class="metric-box-label">At Impact</div>
          <div class="metric-box-value" id="live-impact">--</div>
          <div class="metric-box-unit" id="live-impact-label"></div>
        </div>
        <div class="metric-box">
          <div class="metric-box-label">Tempo</div>
          <div class="metric-box-value" id="live-tempo">0.0</div>
          <div class="metric-box-unit">sec</div>
        </div>
        <div class="metric-box">
          <div class="metric-box-label">Path Dev</div>
          <div class="metric-box-value" id="live-path">0.0</div>
          <div class="metric-box-unit">px</div>
        </div>
        <div class="metric-box">
          <div class="metric-box-label">Strokes</div>
          <div class="metric-box-value" id="live-strokes">0</div>
          <div class="metric-box-unit"></div>
        </div>
      </div>
      
      <!-- Center: Camera -->
      <div class="camera-area">
        <video id="practice-video" autoplay playsinline muted></video>
        <canvas id="practice-canvas" style="display:none;"></canvas>
        <canvas id="practice-overlay"></canvas>
        <canvas id="trace-canvas"></canvas>
        <button class="back-btn-float" id="practice-back-btn">‚Üê Back</button>
        
        <!-- Impact popup -->
        <div class="impact-display" id="impact-display">
          <div class="impact-label">FACE AT IMPACT</div>
          <div class="impact-value" id="impact-value">0.0¬∞</div>
          <div class="impact-hint" id="impact-hint">SQUARE</div>
        </div>
      </div>
      
      <!-- Right: Controls -->
      <div class="controls-panel">
        <button class="ctrl-btn active" id="tracking-btn">ON</button>
        <div class="panel-box">
          <div class="panel-label">Arc</div>
          <div class="panel-value" id="arc-badge">72¬∞</div>
        </div>
        <div class="panel-box">
          <div class="panel-label">BPM</div>
          <div class="panel-value" id="bpm-badge">76</div>
        </div>
        <button class="ctrl-btn" id="metronome-btn">üîá</button>
        <button class="ctrl-btn" id="record-btn">REC</button>
        <button class="ctrl-btn" id="clear-btn">CLEAR</button>
      </div>
    </div>
  </div>

  <!-- Review Screen -->
  <div id="review-screen" class="container hidden">
    <div class="header"><h1 class="title-small">STROKE REVIEW</h1></div>
    
    <div class="review-metrics">
      <div class="review-metric">
        <div class="review-metric-label">FACE AT IMPACT</div>
        <div class="review-metric-value" id="review-face">0.0¬∞</div>
        <div class="review-metric-hint" id="review-face-hint">Square</div>
      </div>
      <div class="review-metric">
        <div class="review-metric-label">TEMPO</div>
        <div class="review-metric-value" id="review-tempo">0.0s</div>
        <div class="review-metric-hint">backswing to impact</div>
      </div>
      <div class="review-metric">
        <div class="review-metric-label">PATH</div>
        <div class="review-metric-value" id="review-path">0px</div>
        <div class="review-metric-hint">deviation from ideal</div>
      </div>
    </div>
    
    <div class="review-video-wrapper">
      <video id="review-video" class="review-video" controls loop playsinline></video>
      <canvas id="review-trace-canvas"></canvas>
    </div>
    
    <div class="toggle-row">
      <button class="toggle-btn active" id="toggle-ideal">Show Ideal Arc</button>
      <button class="toggle-btn active" id="toggle-actual">Show Actual Path</button>
    </div>
    
    <div class="speed-controls">
      <span class="speed-label">Speed:</span>
      <button class="speed-btn" data-speed="0.25">0.25x</button>
      <button class="speed-btn" data-speed="0.5">0.5x</button>
      <button class="speed-btn active" data-speed="1">1x</button>
    </div>
    
    <div class="button-row">
      <button class="primary-btn" id="continue-btn" style="width:auto;">Continue Training</button>
      <button class="secondary-btn" id="settings-btn">Settings</button>
    </div>
  </div>

  <script>
    // ===== STATE =====
    let bpm = 76;
    let arcDegree = 72;
    let metronomeOn = false;
    let trackingOn = true;
    let isRecording = false;
    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let audioContext = null;
    let metronomeInterval = null;
    let animationFrame = null;
    
    // Tracking data
    let trackingData = [];
    let strokeCount = 0;
    let strokeInProgress = false;
    let strokeStartTime = 0;
    let lastPositions = [];
    let impactCaptured = false;
    
    // Calibration
    let ballYPercent = 55;
    let ballXPercent = 50;
    let arcLengthPercent = 38;
    
    // Review display options
    let showIdealArc = true;
    let showActualPath = true;

    // ===== SCREENS =====
    const screens = {
      setup: document.getElementById('setup-screen'),
      calibrate: document.getElementById('calibrate-screen'),
      practice: document.getElementById('practice-screen'),
      review: document.getElementById('review-screen')
    };

    function showScreen(name) {
      Object.values(screens).forEach(s => s.classList.add('hidden'));
      screens[name].classList.remove('hidden');
      if (name === 'practice' || name === 'calibrate') {
        setTimeout(() => { resizeCanvases(); drawOverlay(); }, 50);
      }
      if (name === 'review') {
        setTimeout(drawReviewOverlay, 100);
      }
    }

    function resizeCanvases() {
      const calibrateContainer = document.getElementById('calibrate-camera-container');
      const calibrateCanvas = document.getElementById('calibrate-canvas');
      if (calibrateContainer && calibrateCanvas) {
        calibrateCanvas.width = calibrateContainer.offsetWidth;
        calibrateCanvas.height = calibrateContainer.offsetHeight;
      }
      
      const cameraArea = document.querySelector('.camera-area');
      if (cameraArea) {
        const w = cameraArea.offsetWidth;
        const h = cameraArea.offsetHeight;
        ['practice-overlay', 'trace-canvas'].forEach(id => {
          const c = document.getElementById(id);
          if (c) { c.width = w; c.height = h; }
        });
      }
    }

    // ===== BPM =====
    function updateBpm(value) {
      bpm = Math.max(60, Math.min(90, value));
      document.getElementById('bpm-slider').value = bpm;
      document.getElementById('bpm-display').textContent = bpm;
      document.getElementById('bpm-badge').textContent = bpm;
    }
    
    document.getElementById('bpm-slider').addEventListener('input', e => updateBpm(parseInt(e.target.value)));
    document.getElementById('bpm-minus').addEventListener('click', () => updateBpm(bpm - 1));
    document.getElementById('bpm-plus').addEventListener('click', () => updateBpm(bpm + 1));

    // ===== ARC =====
    document.getElementById('arc-buttons').addEventListener('click', e => {
      if (e.target.dataset.arc) {
        arcDegree = parseInt(e.target.dataset.arc);
        document.getElementById('arc-display').textContent = arcDegree + '¬∞';
        document.getElementById('arc-badge').textContent = arcDegree + '¬∞';
        document.querySelectorAll('.arc-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        drawOverlay();
      }
    });

    // ===== CAMERA =====
    async function startCamera(videoEl) {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 60 } }
        });
        videoEl.srcObject = stream;
        document.getElementById('calibrate-placeholder')?.classList.add('hidden');
        videoEl.onloadedmetadata = () => { resizeCanvases(); drawOverlay(); };
        return true;
      } catch (err) {
        const errEl = document.getElementById('camera-error');
        if (errEl) { errEl.textContent = 'Camera access denied'; errEl.style.display = 'block'; }
        return false;
      }
    }

    function stopCamera() {
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    }

    // ===== AUDIO =====
    function initAudio() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playClick() {
      if (!audioContext) return;
      if (audioContext.state === 'suspended') audioContext.resume();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain); gain.connect(audioContext.destination);
      osc.frequency.value = 800; osc.type = 'sine';
      gain.gain.setValueAtTime(0.3, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
      osc.start(); osc.stop(audioContext.currentTime + 0.08);
    }

    function toggleMetronome() {
      initAudio();
      metronomeOn = !metronomeOn;
      const btn = document.getElementById('metronome-btn');
      if (metronomeOn) {
        btn.textContent = 'üîä'; btn.classList.add('active');
        playClick();
        metronomeInterval = setInterval(playClick, (60 / bpm) * 1000);
      } else {
        btn.textContent = 'üîá'; btn.classList.remove('active');
        if (metronomeInterval) clearInterval(metronomeInterval);
      }
    }

    // ===== OVERLAY DRAWING =====
    function drawOverlay() {
      const c1 = document.getElementById('calibrate-canvas');
      if (c1 && c1.width > 0) drawGuideOnCanvas(c1);
      const c2 = document.getElementById('practice-overlay');
      if (c2 && c2.width > 0) drawGuideOnCanvas(c2);
    }
    
    function drawGuideOnCanvas(canvas) {
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0, 0, W, H);
      
      const centerX = W * (ballXPercent / 100);
      const ballY = H * (ballYPercent / 100);
      const arcLen = H * (arcLengthPercent / 100);
      
      // Arc curve: more curve for lower degrees
      const curveFactor = (90 - arcDegree) / 90;
      const maxCurve = W * 0.04 * curveFactor;
      
      // Draw tick marks along arc
      const numTicks = 13;
      const tickW = W * 0.15;
      
      for (let i = 0; i <= numTicks; i++) {
        const t = i / numTicks;
        const y = (ballY - arcLen) + (arcLen * 2) * t;
        const dist = Math.abs(y - ballY) / arcLen;
        const xOff = maxCurve * dist * dist;
        const x = centerX + xOff;
        
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255,255,255,0.85)';
        ctx.lineWidth = 2;
        ctx.moveTo(x - tickW/2, y);
        ctx.lineTo(x + tickW/2, y);
        ctx.stroke();
      }
      
      // Center reference line (subtle)
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(255,255,255,0.2)';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 8]);
      ctx.moveTo(centerX, ballY - arcLen - 30);
      ctx.lineTo(centerX, ballY + arcLen + 30);
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Ball position circle
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(255,255,255,0.9)';
      ctx.lineWidth = 2;
      ctx.arc(centerX, ballY, 22, 0, Math.PI * 2);
      ctx.stroke();
      
      ctx.fillStyle = 'rgba(255,255,255,0.8)';
      ctx.font = 'bold 11px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('Ball', centerX, ballY - 3);
      ctx.fillText('Here', centerX, ballY + 9);
      
      // Putter zone
      const putterY = ballY - 55;
      ctx.strokeStyle = 'rgba(255,255,255,0.5)';
      ctx.lineWidth = 1;
      ctx.strokeRect(centerX - 35, putterY - 20, 70, 40);
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.font = '10px system-ui';
      ctx.fillText('Putter', centerX, putterY - 3);
      ctx.fillText('Here', centerX, putterY + 9);
    }

    // ===== COLOR TRACKING =====
    function detectColor(imageData, color, W, H) {
      const d = imageData.data;
      let sx = 0, sy = 0, cnt = 0;
      const ranges = {
        blue: { r: [0, 120], g: [80, 220], b: [160, 255] },
        pink: { r: [180, 255], g: [50, 180], b: [130, 255] }
      };
      const rng = ranges[color];
      if (!rng) return null;
      
      for (let y = 0; y < H; y += 2) {
        for (let x = 0; x < W; x += 2) {
          const i = (y * W + x) * 4;
          if (d[i] >= rng.r[0] && d[i] <= rng.r[1] &&
              d[i+1] >= rng.g[0] && d[i+1] <= rng.g[1] &&
              d[i+2] >= rng.b[0] && d[i+2] <= rng.b[1]) {
            sx += x; sy += y; cnt++;
          }
        }
      }
      return cnt > 8 ? { x: sx/cnt, y: sy/cnt, confidence: cnt } : null;
    }

    // ===== STROKE DETECTION & TRACKING =====
    function processFrame() {
      if (!trackingOn) { animationFrame = requestAnimationFrame(processFrame); return; }
      
      const video = document.getElementById('practice-video');
      const canvas = document.getElementById('practice-canvas');
      const ctx = canvas.getContext('2d');
      
      const vw = video.videoWidth || 640;
      const vh = video.videoHeight || 480;
      canvas.width = vw; canvas.height = vh;
      ctx.drawImage(video, 0, 0);
      
      const imageData = ctx.getImageData(0, 0, vw, vh);
      const blue = detectColor(imageData, 'blue', vw, vh);
      const pink = detectColor(imageData, 'pink', vw, vh);
      
      if (blue && pink) {
        const cx = (blue.x + pink.x) / 2;
        const cy = (blue.y + pink.y) / 2;
        const dx = pink.x - blue.x;
        const dy = pink.y - blue.y;
        const rawAngle = Math.atan2(dy, dx) * (180 / Math.PI);
        // Face angle: 0 = square (perpendicular to target line)
        // Positive = open, Negative = closed
        const faceAngle = rawAngle > 0 ? 90 - rawAngle : -90 - rawAngle;
        
        const now = Date.now();
        const dataPoint = { timestamp: now, cx, cy, faceAngle, blue, pink };
        
        // Update live display
        document.getElementById('live-face').textContent = faceAngle.toFixed(1);
        
        // Movement detection for stroke
        lastPositions.push({ cy, time: now });
        if (lastPositions.length > 10) lastPositions.shift();
        
        if (lastPositions.length >= 5) {
          const oldest = lastPositions[0];
          const newest = lastPositions[lastPositions.length - 1];
          const movement = Math.abs(newest.cy - oldest.cy);
          
          // Stroke start detection
          if (!strokeInProgress && movement > 15) {
            strokeInProgress = true;
            strokeStartTime = now;
            trackingData = [];
            impactCaptured = false;
          }
          
          // During stroke
          if (strokeInProgress) {
            trackingData.push(dataPoint);
            drawStrokeTrace();
            
            // Impact detection: putter crosses ball Y position
            const ballY = vh * (ballYPercent / 100);
            const prevPoint = trackingData[trackingData.length - 2];
            if (prevPoint && !impactCaptured) {
              const crossedBall = (prevPoint.cy > ballY && cy <= ballY) || 
                                  (prevPoint.cy < ballY && cy >= ballY);
              if (crossedBall) {
                captureImpact(faceAngle, now);
              }
            }
            
            // Stroke end detection (movement stops)
            if (movement < 3 && trackingData.length > 20) {
              endStroke();
            }
          }
        }
      }
      
      animationFrame = requestAnimationFrame(processFrame);
    }

    function captureImpact(faceAngle, time) {
      impactCaptured = true;
      const tempo = ((time - strokeStartTime) / 1000).toFixed(2);
      
      // Update live metrics
      document.getElementById('live-impact').textContent = faceAngle.toFixed(1) + '¬∞';
      document.getElementById('live-tempo').textContent = tempo;
      
      let hint = 'SQUARE';
      let cls = 'square';
      if (faceAngle > 0.5) { hint = 'OPEN'; cls = 'open'; }
      else if (faceAngle < -0.5) { hint = 'CLOSED'; cls = 'closed'; }
      
      document.getElementById('live-impact-label').textContent = hint;
      
      // Show impact popup
      const popup = document.getElementById('impact-display');
      const valEl = document.getElementById('impact-value');
      const hintEl = document.getElementById('impact-hint');
      
      valEl.textContent = faceAngle.toFixed(1) + '¬∞';
      valEl.className = 'impact-value ' + cls;
      hintEl.textContent = hint;
      hintEl.className = 'impact-hint';
      hintEl.style.color = cls === 'square' ? '#4ade80' : cls === 'open' ? '#f97316' : '#3b82f6';
      
      popup.classList.remove('show');
      void popup.offsetWidth; // Reset animation
      popup.classList.add('show');
      
      setTimeout(() => popup.classList.remove('show'), 3000);
    }

    function endStroke() {
      strokeInProgress = false;
      strokeCount++;
      document.getElementById('live-strokes').textContent = strokeCount;
      
      // Calculate path deviation
      if (trackingData.length > 0) {
        const canvas = document.getElementById('practice-canvas');
        const idealCenterX = canvas.width * (ballXPercent / 100);
        let totalDev = 0;
        trackingData.forEach(p => { totalDev += Math.abs(p.cx - idealCenterX); });
        const avgDev = (totalDev / trackingData.length).toFixed(1);
        document.getElementById('live-path').textContent = avgDev;
      }
      
      lastPositions = [];
    }

    function drawStrokeTrace() {
      const canvas = document.getElementById('trace-canvas');
      const ctx = canvas.getContext('2d');
      const video = document.getElementById('practice-video');
      
      // Scale from video coords to canvas coords
      const scaleX = canvas.width / (video.videoWidth || 640);
      const scaleY = canvas.height / (video.videoHeight || 480);
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (trackingData.length < 2) return;
      
      // Draw actual stroke path
      ctx.beginPath();
      ctx.strokeStyle = '#ff6b35';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      trackingData.forEach((p, i) => {
        const x = p.cx * scaleX;
        const y = p.cy * scaleY;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Draw putter head indicator at current position
      const last = trackingData[trackingData.length - 1];
      const lx = last.cx * scaleX;
      const ly = last.cy * scaleY;
      
      ctx.beginPath();
      ctx.fillStyle = '#ff6b35';
      ctx.arc(lx, ly, 6, 0, Math.PI * 2);
      ctx.fill();
    }

    function clearTrace() {
      trackingData = [];
      lastPositions = [];
      strokeInProgress = false;
      impactCaptured = false;
      const canvas = document.getElementById('trace-canvas');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      document.getElementById('live-impact').textContent = '--';
      document.getElementById('live-impact-label').textContent = '';
      document.getElementById('live-tempo').textContent = '0.0';
      document.getElementById('live-path').textContent = '0.0';
    }

    // ===== RECORDING =====
    function toggleRecording() {
      const btn = document.getElementById('record-btn');
      if (!isRecording) {
        recordedChunks = [];
        trackingData = []; // Reset tracking for this recording
        
        const options = { mimeType: 'video/webm;codecs=vp9' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType = 'video/webm';
        
        mediaRecorder = new MediaRecorder(stream, options);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          document.getElementById('review-video').src = URL.createObjectURL(blob);
          calculateReviewMetrics();
          showScreen('review');
        };
        
        mediaRecorder.start(100);
        isRecording = true;
        btn.textContent = 'STOP';
        btn.classList.add('recording');
      } else {
        mediaRecorder.stop();
        isRecording = false;
        btn.textContent = 'REC';
        btn.classList.remove('recording');
      }
    }

    function calculateReviewMetrics() {
      // Find impact point in tracking data
      let impactFace = 0;
      let impactTime = 0;
      let totalDev = 0;
      
      if (trackingData.length > 0) {
        const video = document.getElementById('practice-video');
        const ballY = (video.videoHeight || 480) * (ballYPercent / 100);
        const idealX = (video.videoWidth || 640) * (ballXPercent / 100);
        
        // Find impact
        for (let i = 1; i < trackingData.length; i++) {
          const prev = trackingData[i-1];
          const curr = trackingData[i];
          if ((prev.cy > ballY && curr.cy <= ballY) || (prev.cy < ballY && curr.cy >= ballY)) {
            impactFace = curr.faceAngle;
            impactTime = (curr.timestamp - trackingData[0].timestamp) / 1000;
            break;
          }
        }
        
        // Calculate deviation
        trackingData.forEach(p => { totalDev += Math.abs(p.cx - idealX); });
      }
      
      const avgDev = trackingData.length > 0 ? (totalDev / trackingData.length).toFixed(1) : 0;
      
      // Update review display
      const faceEl = document.getElementById('review-face');
      faceEl.textContent = impactFace.toFixed(1) + '¬∞';
      faceEl.className = 'review-metric-value';
      
      let hint = 'Square';
      if (impactFace > 0.5) { hint = 'Open'; faceEl.classList.add('open'); }
      else if (impactFace < -0.5) { hint = 'Closed'; faceEl.classList.add('closed'); }
      else { faceEl.classList.add('square'); }
      
      document.getElementById('review-face-hint').textContent = hint;
      document.getElementById('review-tempo').textContent = impactTime.toFixed(2) + 's';
      document.getElementById('review-path').textContent = avgDev + 'px';
    }

    function drawReviewOverlay() {
      const wrapper = document.querySelector('.review-video-wrapper');
      const canvas = document.getElementById('review-trace-canvas');
      if (!wrapper || !canvas) return;
      
      canvas.width = wrapper.offsetWidth;
      canvas.height = wrapper.offsetHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const video = document.getElementById('review-video');
      const vw = video.videoWidth || 640;
      const vh = video.videoHeight || 480;
      const scaleX = canvas.width / vw;
      const scaleY = canvas.height / vh;
      
      // Draw ideal arc
      if (showIdealArc) {
        const centerX = canvas.width * (ballXPercent / 100);
        const ballY = canvas.height * (ballYPercent / 100);
        const arcLen = canvas.height * (arcLengthPercent / 100);
        const curveFactor = (90 - arcDegree) / 90;
        const maxCurve = canvas.width * 0.04 * curveFactor;
        
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255,255,255,0.5)';
        ctx.lineWidth = 2;
        ctx.setLineDash([6, 4]);
        
        for (let i = 0; i <= 30; i++) {
          const t = i / 30;
          const y = (ballY - arcLen) + (arcLen * 2) * t;
          const dist = Math.abs(y - ballY) / arcLen;
          const x = centerX + maxCurve * dist * dist;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.setLineDash([]);
      }
      
      // Draw actual path
      if (showActualPath && trackingData.length > 1) {
        ctx.beginPath();
        ctx.strokeStyle = '#ff6b35';
        ctx.lineWidth = 3;
        
        trackingData.forEach((p, i) => {
          const x = p.cx * scaleX;
          const y = p.cy * scaleY;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }
    }

    // ===== EVENT LISTENERS =====
    document.getElementById('start-btn').addEventListener('click', async () => {
      showScreen('calibrate');
      await startCamera(document.getElementById('calibrate-video'));
    });

    document.getElementById('calibrate-camera-btn').addEventListener('click', async () => {
      await startCamera(document.getElementById('calibrate-video'));
    });

    document.getElementById('calibrate-back-btn').addEventListener('click', () => {
      stopCamera();
      showScreen('setup');
    });

    document.getElementById('confirm-calibrate-btn').addEventListener('click', () => {
      document.getElementById('practice-video').srcObject = stream;
      showScreen('practice');
      setTimeout(() => { resizeCanvases(); drawOverlay(); processFrame(); }, 100);
    });

    document.getElementById('practice-back-btn').addEventListener('click', () => {
      if (animationFrame) cancelAnimationFrame(animationFrame);
      if (metronomeOn) toggleMetronome();
      if (isRecording) toggleRecording();
      stopCamera();
      showScreen('setup');
    });

    document.getElementById('tracking-btn').addEventListener('click', () => {
      trackingOn = !trackingOn;
      const btn = document.getElementById('tracking-btn');
      btn.textContent = trackingOn ? 'ON' : 'OFF';
      btn.classList.toggle('active', trackingOn);
    });

    document.getElementById('metronome-btn').addEventListener('click', toggleMetronome);
    document.getElementById('record-btn').addEventListener('click', toggleRecording);
    document.getElementById('clear-btn').addEventListener('click', clearTrace);

    document.getElementById('toggle-ideal').addEventListener('click', e => {
      showIdealArc = !showIdealArc;
      e.target.classList.toggle('active', showIdealArc);
      drawReviewOverlay();
    });

    document.getElementById('toggle-actual').addEventListener('click', e => {
      showActualPath = !showActualPath;
      e.target.classList.toggle('active', showActualPath);
      drawReviewOverlay();
    });

    document.querySelectorAll('.speed-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        document.getElementById('review-video').playbackRate = parseFloat(e.target.dataset.speed);
        document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
      });
    });

    document.getElementById('continue-btn').addEventListener('click', () => {
      clearTrace();
      showScreen('practice');
      if (!animationFrame) processFrame();
    });

    document.getElementById('settings-btn').addEventListener('click', () => {
      stopCamera();
      showScreen('setup');
    });

    window.addEventListener('resize', () => { resizeCanvases(); drawOverlay(); });
    
    // Initialize
    updateBpm(76);
  </script>
</body>
</html>
